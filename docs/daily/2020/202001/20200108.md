## 概要

1. navfnについて
2. ダイクストラ法
3. A-star法
4. cube-petit(バッテリーの持ち時間について)

---

## 疑問点

* visualize_potentialの領域とは？
* default_toleranceはメートル？
* planner_window_xのウィンドウとは？
---

## navfn

* navfnは大域的経路計画で使用するパッケージの一つ  
* **Navigation Function**と呼ばれるポテンシャル場で評価する
    * グローバルコストマップを見て、ゴールまでの距離と障害物からの距離をコストとする
* 円形ロボットを想定し、方向は考慮しない
    * 方向によっては障害物と衝突する
* ダイクストラ法を用いて計算されるが将来A*ヒューリスティクス法もサポートされる可能性あり

### パブリッシュするトピック

* plan: 最後に計算されたルート、新しいパスを計算するたびに公開される

### パラメータ

* **allow_unknown**(bool):未知の空間を横断するルートを作成するか、デフォルトtrue
    * コストマップのvoxelまたはobstacle layerの**track_unknown_space**パラメータもtrueにする必要
* **planner_window_x**(double):経路計画を制限するオプションウィンドウサイズのxサイズ、デフォルトは0.0
* **planner_window_y**(double):経路計画を制限するオプションウィンドウサイズのyサイズ、デフォルトは0.0
* **default_tolerance**(double):ゴールポイントの許容値、指定された目標に限りなく近く、この値を超えないルートを作成する。デフォルトは0.0
* **visualize_potential**(bool):PointCloud2を通して潜在的な領域をを視覚化するか、デフォルトfalse





---




### ダイクストラ法

最短経路問題をグラフを用いて効率的にとくアルゴリズム  
スタートからゴールまでの最短距離と経路を求める  
[ここを参考にする](http://www.deqnotes.net/acmicpc/dijkstra/)

#### 流れ

* 各地点をノード、地点間のルートをエッジ、エッジを通るのに必要なコストを定義する
* スタートノードからゴールノードまでに行くルートの中で最小コストになるルートを見つける
* スタートノードのコストを0、その他のノードのコストを無限大にする

1. 通ったこと無いノードから最小コストのノードを選択する
2. 選択したノードからエッジを通り到達できるノードをすべて挙げる(既に通ったノードは無視する)
3. 挙げたノード全てに対してコストを計算し、以前のコストより小さければ更新して選択ノードを保存する
4. 1へ戻るかすべてのノードに行っていたら終了
 
```
  ^--(2)--[ A ]--(6)--[ D ]
  |         |(4)        |(6) 
[ S ]-(3)-[ B ]       [ G ]
  |         |(2)        |
  ^--(6)--[ C ]--(4)----^
```

1. スタートノード(コストは0)から行けるノードのコストを計算する

* Aのコストは```S→A```のルートで2
* Bのコストは```S→B```のルートで3
* Cのコストは```S→C```のルートで6

| ノード | 最小コスト |　既知 | ルート |
| - | - |  - | - |
| S | 0 | Y　| S |
| A | 2 |    | S,A |
| B | 3 |    | S,B |
| C | 6 |    | S,C |
| D | -1 |    |  |
| G | -1|    |  |

2. 行ったことのないノードの中で最小コストはA、Aから行けるノードのコストを計算する

* Dのコストは```S→A→D```のルートで7、これは最小コストなので更新する(A→Dのルートを保存)
* Bのコストは```S→A→B```のルートで6、これは最小コストではないので更新なし

| ノード | 最小コスト |　既知 | ルート |
| - | - |  - | - |
| S | 0 | Y　| S |
| A | 2 | Y   | S,A |
| B | 3 |    | S,B |
| C | 6 |    | S,C |
| D | 7 |    | S,A,D |
| G | -1|    |  |

3. 行ったことのないノードの中で最小コストはB、Bから行けるノードのコストを計算する

* Dのコストは```S→B→D```のルートで5、これは最小コストなので更新する(B→Dのルートを保存)
* Cのコストは```S→B→C```のルートで5、これは最小コストなので更新する(B→Cのルートを保存)

| ノード | 最小コスト |　既知 | ルート |
| - | - |  - | - |
| S | 0 | Y　| S |
| A | 2 | Y  | S,A |
| B | 3 | Y  | S,B |
| C | 5 |    | S,B,C |
| D | 5 |    | S,B,D |
| G | -1|    |  |

4. 行ったことのないノードの中で最小コストはC、Cから行けるノードのコストを計算する

* Gのコストは```S→B→C→G```のルートで9、これは最小コストなので更新する(C→Gのルートを保存)

| ノード | 最小コスト |　既知 | ルート |
| - | - |  - | - |
| S | 0 | Y　| S |
| A | 2 | Y  | S,A |
| B | 3 | Y  | S,B |
| C | 5 | Y   | S,B,C |
| D | 5 |    | S,B,D |
| G | 9|    | S,B,C,G |

5. 行ったことのないノードの中で最小コストはD、Dから行けるノードのコストを計算する

* Gのコストは```S→B→D→G```のルートで11、これは最小コストではないので更新しない

| ノード | 最小コスト |　既知 | ルート |
| - | - |  - | - |
| S | 0 | Y　| S |
| A | 2 | Y  | S,A |
| B | 3 | Y  | S,B |
| C | 5 | Y   | S,B,C |
| D | 5 | Y   | S,B,D |
| G | 9|    | S,B,C,G |

6. 通ったこと無いノードがないので終了

ゴールへの最短距離は9でルートは　```S→B→C→G```となる


### A-star法

最短経路問題をグラフを用いて効率的にとくアルゴリズム  
スタートからゴールまでの最短距離と経路を求める  
**スタート地点からある地点までのコスト**と、**ある地点からゴール地点までの予測されるコスト**を用いる  
ダイクストラ法の改良版、ゴールまでの大体の方向と距離がわかっていれば使用可能  
[参考](https://qiita.com/2dgames_jp/items/f29e915357c1decbc4b7)

### 流れ

* 各地点をノード、地点間のルートをエッジ、エッジを通るのに必要なコストを定義する
* スタートノードからゴールノードまでに行くルートの中で最小コストになるルートを見つける

* コストは実コストと推定コストの和で表される
    * 実コストはスタートノードを0としてスタートノードからの距離
    * 推定コストはゴールノードからの距離
        * この時の推定コストは実際のゴールまでの距離より小さくないといけない
        * x軸方向の距離またはy軸方向の距離のうち大きい値を推定コストにする
* １度通ったノードは通らない

1. スタートノードから行けるノードのコストを計算する
2. 通ったことのないノードから最低コストのノードを見つけて周りのコストを計算する
3. ゴールにたどり着いたら終了

### 注意点

* ゴールは移動しない


## cube-petit(バッテリーの持ち時間について)

### 使用したモバイルバッテリー

* [20100mAh](https://www.amazon.co.jp/RAVPower-20100mAh-%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB%E3%83%90%E3%83%83%E3%83%86%E3%83%AA%E3%83%BC-Type-C%E3%82%B1%E3%83%BC%E3%83%96%E3%83%AB%E4%BB%98-RP-PB059/dp/B0713ZKQWG/ref=sr_1_2?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&keywords=12V+%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB%E3%83%90%E3%83%83%E3%83%86%E3%83%AA%E3%83%BC+RAV&qid=1578557363&sr=8-2)
    * 17.2 x 8 x 2 cm
    * 390 g*
    * bringupとgmappingの起動、PS3コントローラで常にモータを動かして**5.5時間**


* [26800mAh](https://www.amazon.co.jp/RAVPower-26800mAh-USB-C%E3%82%B1%E3%83%BC%E3%83%96%E3%83%AB%E4%BB%98-MacBook-RP-PB058/dp/B06XTLKRKY/ref=pd_aw_sbs_147_1/355-7792040-9746067?_encoding=UTF8&pd_rd_i=B06XTLKRKY&pd_rd_r=69364cdc-f945-4f78-a1d7-91965d9cf5bd&pd_rd_w=TWODB&pd_rd_wg=SiJsu&pf_rd_p=71705245-1186-4bae-9f36-3aedbc1d2c0a&pf_rd_r=JW9A5JAR7GVYBTVQZYFD&psc=1&refRID=JW9A5JAR7GVYBTVQZYFD)
    * 17.2 x 8.1 x 2.2 cm
    * 490 g
    * bringupとnabigationの起動時は **6.5時間**
