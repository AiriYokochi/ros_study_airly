## 概要

1. move_baseについての調査
2. costmap_2dパッケージ

---

## 疑問点

* Costmap2dを使っている理由:扱いやすいから...?
    * 2択じゃなかった。選択肢はない解決
* costmap2dのinfrationは壁あたりのコストを計算しているのかロボット周りのコストを計算しているのか
    * 壁の周りのコストをロボットの内接円の長さ＋α分大きくしている
* combination_methodパラメータとは何と何のレイヤーを混ぜてる？
    * obstacleならstatic + obstacle? inflation layerで増やした値は...?

[navigation/costmap_2d/cfg/ObstaclePlugin.cfg](https://github.com/ros-planning/navigation/blob/melodic-devel/costmap_2d/cfg/ObstaclePlugin.cfg)
```
combo_enum = gen.enum([gen.const("Overwrite", int_t,  0, "Overwrite values"),
                       gen.const("Maximum",   int_t,  1, "Take the maximum of the values"),
                       gen.const("Nothing",   int_t, 99, "Do nothing")],
                       "Method for combining layers enum")
gen.add("combination_method", int_t, 0, "Method for combining two layers", 1, edit_method=combo_enum)
```

---

## move_baseについての調査

### 概要

move_baseは**ゴール**が与えられたとき

1. **地図/センサ/自己位置推定**の値から障害物の場所を表した**コストマップ**を作成し、  
2. コストマップからゴールまでの**経路を生成**し、
3. モータコントローラに**速度指令**を送る
パッケージである。  

### 経路

経路には２種類ある

* **Global Path**:**大域的**な経路と言われる、ゴールまでの経路
* **Local Path**:**局所的**な経路と言われる、今現在の自分の周りの状況をみて障害物や人を避けた経路

<img src="../pictures/move_base.JPG" width="640px">

### コストマップ

２次元の**占有格子地図**という。マップに関しては[20200105.md](./20200105.md)のmap_serverについてを参照  
各グリッドの障害物っぽさを表す

* OccupancyGrid
    * 型名。int型で、各グリッドは0~100の値または-1(未知)
* Costmap2D
    * パッケージ名。unsigned char型で各グリッドを0~254の値または255(未知)で表す

### move_baseを構成する機能5つ

### action API

### PUBSUBトピック

### サービス

### パラメータ




---



## costmap_2dパッケージ

move_baseで使用しているコストマップを作成するパッケージで、センサの値から2dマップを作成する。  
マップデータとセンサデータから障害物の情報を更新する
Costmap2Dではコスト値は0~254を取り、**0は空きスペース**、**254は占有スペース**を表す。

<img src="../pictures/costmap_2d.JPG" width="640px">


## レイヤー

costmap_2dはレイヤーと呼ばれる複数のPluginから構成される、各レイヤーの機能を説明する

* **Static Map Layer**: **SLAM**によって生成されたものなど、コストマップのほとんど変化しない部分を表示
* **Obstacle Map Layer**: **センサ**データによって読み取られた部分の表示
    * **Obstacle Costmap Plugin**: 2次元データを扱う
    * **Voxel Costmap Plugin**: 3次元データを扱う
* **Infration Layer**: 障害物を膨張させることで**障害物周りにコストを追加**する、コストマップがロボットの構成空間を表す
(その他)
* Social Costmap Layer:人をコストマップに表示

上から順に実行される

### インフレーションとは

コストの値をロボットの中心セルからの距離が遠くなるほど減少させていくプロセス

5つの特徴的なシンボルを定義する

* **Lethal(253~254)**::致命的なコストで、ロボットの中心がそのセルにある場合明らかにぶつかっている
    * 253でロボットの内接円コスト値
* **Inscribed**(128~252)::内接コスト、セルがロボットの内接円より小さい場合でが確かにぶつかっている
* **Possibly circumsucribed**(1~127)::外接コスト、セルがロボットの外接円より大きい場合でぶつからない
* **Freespace**(0)::空き、
* **Unknown**(255)::データ無し

<img src="../pictures/infration.JPG" width="640px">

### サブスクライブトピック

* **footprint**(string): robot_base_frameの占有領域をリスト形式で表す、[[x1, y1], [x2, y2], ...., [xn, yn]]デフォルトは空リスト

### パブリッシュトピック

* **costmap**:コストマップの値
* **costmap_updates**:コストマップの更新された領域の値
* **voxel_grid**:3次元データを使用し、ユーザが3次元グリッドの公開を要求したときにpublishされる

### パラメータ

* **plugins**:plugin名を指定
* **global_frame**:フレーム名、デフォルトはmap
* **robot_base_frame**:ロボットのベースリンクのフレーム名、デフォルトはframe_link
* **rolling_window**:ウィンドウが回転するバージョンのコストマップを使用するか、static_mapがtrueならこれはfalse
* **always_send_full_costmap**:更新のたびにコストマップをすべてパブリッシュするかか否か
    * falseで変更部分だけがトピック**costmap_updates**にパブリッシュされる


### 各レイヤーのパラメータ

### costmap_2Dのパラメータ

* **transform_tolerance**(double):許容できるtfデータの遅延[sec],0.3[sec],0~10[sec]

    * 0.2秒は許容範囲内で8秒古いと許容範囲外
    * mapとbase_linkフレームの変換がros::Time::now()よりもこの秒古い場合、ロボットが停止する

* **update_frequency(double)**:マップ更新頻度、デフォルトで5[Hz],0~100[Hz]
* **publish_frequency(double)**:マップをパブリッシュする頻度、0[Hz],0~100[Hz]

#### map関連

static_map_layerで上書き可能な値

* **width**(int):マップの幅、単位はメートル、デフォルト10[m]
* **height**(int):マップの高さ、単位はメートル、デフォルト10[m]
* **resolusion**(double):マップの解像度で１セルのサイズ、単位は[m/cell]、デフォルトは0.05[m/cell]、最大値は50
* **origin_x**(double):globalフレームからのマップのx座標原点、単位は[m]、デフォルトは0[m]
* **origin_y**(double):globalフレームからのマップのx座標原点、単位は[m]、デフォルトは0[m]

#### robot footprint関連

* **footprint**(string): robot_base_frameの占有領域をリスト形式で表す、[[x1, y1], [x2, y2], ...., [xn, yn]]デフォルトは空リスト
* **robot_radius**(double):ロボットの半径、単位は[m]、円型のロボットのみ設定してそれ以外は設定しない、デフォルトは0.46[m]、最大は10[m]
* **footprint_padding**(double):ロボット占有領域のpadding、単位は[m]、デフォルトは0.1[m]

### infrationのパラメータ

* **cost_scaling_factor**(double):インフレーション時にコスト値に適用される係数、デフォルト10, 0~100
* **infration_radius**(double):地図が障害物のコスト値をふくらませる半径、デフォルト0.55[m],0~50[m]
* **inflate_unknown**(bool):未知のセルに適用するかどうか,デフォルトfalse

### obstacleのパラメータ

* **footprint_clearing_enabled**(bool):致命的な障害物のロボットの占有領域をクリアするか否か(?)、デフォルトTrue
* **max_obstacle_height**(double):コストマップに挿入される障害物の最題の高さ、デフォルト2[m],0~50[m]
* **combination_method**(int):2レイヤーを混ぜる方法。デフォルト1
    * それ以外のレイヤーから入ってくるデータに対してどう値を処理するか
    * 0  ならば上書きするので他レイヤーの値は使わない
    * 1  ならば受信したデータと自レイヤーを比較して最大値を取る、だいたいこれ
    * 99 ならば受信データを変更しない
    * track_unknown_spaceパラメータによってコストマップの動作が変わるので注意

(オプション：コメントアウト)

* **max_obstacle_range**(double):ロボットからこの距離までの障害物はコストマップに反映される、デフォルトは2.5[m]、0~50[m]
* **raytrace_range**(double):センサデータを使用して障害物を地図に反映させる範囲、デフォルトは3[m],0~50[m]

### voxelパラメータ

* **footprint_clearing_enabled**(bool):致命的な障害物のロボットの占有領域をクリアするか否か(?)、デフォルトTrue
* **max_obstacle_height**(double)t:コストマップに挿入される障害物の最題の高さ、デフォルト2[m],0~50[m]
* **orizin_z**(double):globalフレームからのマップのz座標原点、単位は[m]、デフォルトは0[m]
* **z_resolution**(double):マップの解像度で１セルの高さ、単位は[m/cell]、デフォルトは0.2[m/cell]、最大値は50
* **z_voxels**(int):各垂直列のボクセル数、デフォルト10個、0~16個
* **unknown_threshold**(int):１列で不明なセルの数がこの数以下なら、この列は知っているとみなされる、デフォルト15個、0~16個
    * 15なら、1セルの高さの中で１つ高さだけでもわかれば、その列は既知とみなす
* **mark_threshold**(int):マークされたセルの最大数、この列は開いているとみなされる、デフォルトは0,0~16
    * 0なら、１セルの高さの中で１つでも障害物があればそのセルは開いていない
* **combination_method**(int):2レイヤーを混ぜる方法。デフォルト1
    * それ以外のレイヤーから入ってくるデータに対してどう値を処理するか
    * 0  ならば上書きするので他レイヤーの値は使わない
    * 1  ならば受信したデータと自レイヤーを比較して最大値を取る、だいたいこれ
    * 99 ならば受信データを変更しない
    * track_unknown_spaceパラメータによってコストマップの動作が変わるので注意

---
